{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Talk Data to Me</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#f9fafb',
            secondary: '#f3f4f6',
            accent: '#e5e7eb',
          },
        },
      },
    };

    document.addEventListener("DOMContentLoaded", function () {
      const mainLogo = document.getElementById("mainLogo");
      const toggleButton = document.getElementById("toggleSidebar");
      const sidebar = document.getElementById("sidebar");
      const textarea = document.querySelector("textarea");
      const counter = document.querySelector("span.text-xs");
      const submitButton = document.getElementById("submitButton");
      const chatHistory = document.getElementById("chatHistory");
      const sidebarConvos = document.getElementById("sidebarConversations");

      let conversations = [];

      if (mainLogo) {
        mainLogo.classList.add("logo-small");
      }

      if (toggleButton && sidebar) {
        toggleButton.addEventListener("click", function () {
          sidebar.classList.toggle("w-16");
          sidebar.classList.toggle("w-64");
        });
      }

      if (textarea && counter) {
        textarea.addEventListener("input", () => {
          counter.textContent = `${textarea.value.length}/2000`;
        });
      }

      async function askAI() {
        const prompt = textarea.value.trim();
        if (!prompt) {
          alert("Please enter a question or request.");
          return;
        }

        // Create a title based on the first 5 words of the prompt
        const title = prompt.split(" ").slice(0, 5).join(" ") + "...";

        // Store conversation
        conversations.push({ title, messages: [{ sender: "user", message: prompt }] });
        renderSidebarConversations();

        appendMessage("user", prompt);
        textarea.value = '';
        counter.textContent = `0/2000`;

        try {
          const response = await fetch("/api/ask/", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({ prompt }),
          });

          const data = await response.json();
          if (response.ok) {
            appendMessage("ai", data.response);
            conversations[conversations.length - 1].messages.push({ sender: "ai", message: data.response });
          } else {
            alert("Error: " + data.error);
          }
        } catch (error) {
          alert("Request failed: " + error.message);
        }
      }

      function appendMessage(sender, message) {
        const messageElement = document.createElement("div");
        messageElement.classList.add("flex", "w-full", "mb-2", sender === "user" ? "justify-end" : "justify-start");

        const messageBubble = document.createElement("div");
        messageBubble.classList.add(
          "max-w-sm",
          "p-3",
          "rounded-lg",
          "text-sm",
          "shadow-md",
          ...(sender === "user"
            ? ["bg-gray-200", "text-gray-800", "self-end"]
            : ["bg-purple-100", "text-purple-800", "self-start"])
        );
        messageBubble.textContent = message;

        messageElement.appendChild(messageBubble);
        chatHistory.appendChild(messageElement);
        chatHistory.scrollTop = chatHistory.scrollHeight;
      }

      function renderSidebarConversations() {
        sidebarConvos.innerHTML = ""; // Clear previous entries

        conversations.forEach((conv, index) => {
          const btn = document.createElement("button");
          btn.className = "text-left text-xs p-2 w-full hover:bg-gray-100 truncate";
          btn.textContent = conv.title;
          btn.addEventListener("click", () => loadConversation(index));
          sidebarConvos.appendChild(btn);
        });
      }

      function loadConversation(index) {
        const chatHistory = document.getElementById("chatHistory");
        chatHistory.innerHTML = "";
        conversations[index].messages.forEach(msg => {
          appendMessage(msg.sender, msg.message);
        });
      }

      if (submitButton) {
        submitButton.addEventListener("click", askAI);
      }
    });
  </script>
</head>
<body class="bg-primary text-gray-900 h-screen flex">

  <!-- Sidebar -->
  <aside id="sidebar" class="w-16 transition-all duration-300 bg-white border-r border-gray-200 flex flex-col justify-between py-4 shadow-lg">
    <div class="space-y-6 flex flex-col items-start"> <!-- Align items to the left -->
      <nav class="flex flex-col items-start space-y-6"> <!-- Align buttons to the left -->
        <button id="toggleSidebar" class="w-10 h-10 rounded-md bg-gray-100 hover:bg-gray-200 flex items-center justify-center" aria-label="Toggle sidebar">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </nav>

      <div id="sidebarConversations" class="overflow-y-auto flex-1 mt-4 px-2 w-full">
        <!-- List of conversation titles will appear here -->
      </div>
    </div>
    <div class="flex r">
      <img src="https://i.pravatar.cc/36" class="w-8 h-8 rounded-full border border-gray-300" alt="User Avatar" />
    </div>
  </aside>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col items-center justify-center px-6 w-[900px] max-w-2xl mx-auto">
    <div class="max-w-xl w-full space-y-0">
      <div class="flex justify-center items-center shadow-purple-500/40">
        <img src="{% static 'logo/logo.png' %}" id="mainLogo" class="mb-3 w-20 h-6 rounded-20 shadow-2xl" />
      </div>

      <div class="text-center">
        <p class="text-sm text-gray-500 mt-1">Choose a prompt below or write your own to start chatting with Seam</p>
      </div>

      <!-- Chat History Section -->
      <div id="chatHistory" class="bg-gray p-4 max-h-96 overflow-y-auto space-y-4 mb-6 w-full">
        <!-- Messages will be appended here -->
      </div>

      <!-- User Input Section -->
      <div class="bg-white border border-gray-300 rounded-xl p-4 flex items-start gap-3">
        <svg class="w-5 h-5 text-gray-400 mt-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-3-3v6" />
        </svg>
        <div class="flex-1">
          <textarea class="w-full text-sm bg-transparent resize-none focus:outline-none" rows="2" placeholder="Ask AI a question or make a request..." maxlength="2000"></textarea>
          <div class="flex justify-between items-center mt-2">
            <span class="text-xs text-gray-400">0/2000</span>
          </div>
        </div>
        <button id="submitButton" class="text-gray-500 hover:text-blue-600" aria-label="Submit">
          <svg class="w-5 h-5 mt-1" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" />
          </svg>
        </button>
      </div>
    </div>
  </main>
</body>
</html>
